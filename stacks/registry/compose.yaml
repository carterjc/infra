version: "3.8"

volumes:
  registry_data:
  registry_auth:

services:
  registry:
    image: registry:2
    restart: unless-stopped
    depends_on:
      registry-auth-init:
        condition: service_completed_successfully
    environment:
      # storage
      REGISTRY_STORAGE_FILESYSTEM_ROOTDIRECTORY: /var/lib/registry
      # auth (basic)
      REGISTRY_AUTH: htpasswd
      REGISTRY_AUTH_HTPASSWD_REALM: "Registry Realm"
      REGISTRY_AUTH_HTPASSWD_PATH: htpasswd
      REGISTRY_HTTP_SECRET: ${REGISTRY_HTTP_SECRET}
      # (optional) allow CORS for web UIs; safe to leave
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Origin: '["*"]'
      REGISTRY_HTTP_HEADERS_Access-Control-Allow-Methods: '["HEAD","GET","OPTIONS","DELETE","PUT","POST"]'
    volumes:
      - registry_data:/var/lib/registry
      - registry_auth:/auth:ro
    networks:
      - cloudflare-net
    labels:
      - dockflare.enable=true
      - dockflare.hostname=registry.costic.dev
      - dockflare.service=http://registry:5000
      - dockflare.access.policy=bypass   # public, but requires Docker login

networks:
  cloudflare-net:
    external: true
    name: cloudflare-net
